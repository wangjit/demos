<!doctype html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Document</title>
  <style>
    * {
      margin: 0;
      padding: 0;
    }

    .content {
      height: 930px;
      position: relative;
    }

    .item {
      position: absolute;
      width: 200px;
      margin-right: 10px;
      margin-top: 10px;
      transition: all 1s;
    }

    .h1 {
      height: 200px;
      background-color: #fed136;
    }

    .h2 {
      height: 300px;
      background-color: #f44336;
    }

    .h3 {
      height: 400px;
      background-color: #006ac1;
    }

    .loadMore {
      text-align: center;
      height: 100px;
      margin-top: 40px;
    }

    .loadMore a {
      border: 2px solid #bfbfbf;
      text-decoration: none;
      text-align: center;
      width: 59px;
      color: #000000;
      font-size: 13px;
      padding: 10px 0;
      box-shadow: rgb(191,191,191) 0 0 5px 0;
      border-radius: 13px;
      background: -webkit-gradient(linear, 0% 0%, 0% 100%, from(#eef0ea), to(#bfbfbf));
      opacity: 0.5;
    }

    .loadMore a:hover {
      opacity: 1;
    }
    .test{
      width: 500px;
      height: 400px;
      border: 1px solid;
    }
  </style>
</head>
<body>
<div class="test"></div>
<div class="content">
  <div class="item h1">1</div>
  <div class="item h3">2</div>
  <div class="item h2">3</div>
  <div class="item h1">4</div>
  <div class="item h1">5</div>
  <div class="item h3">6</div>
  <div class="item h2">7</div>
  <div class="item h1">8</div>
  <div class="item h3">9</div>
  <div class="item h1">10</div>
  <div class="item h2">11</div>
  <div class="item h3">12</div>
  <div class="item h2">13</div>
  <div class="item h1">14</div>
</div>
<div class="loadMore">
  <a href="#" class="lm">加载更多</a>
</div>

<script src="https://cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
<script>


  var WaterFull = (function () {
    function waterFull($ct) {
      this.$ct = $ct;
      this.init();
      let that = this;
      $(window).resize(function () {
        that.init();
      })
    }

    waterFull.prototype.init = function () {

      let colLength = parseInt(this.$ct.width() / this.$ct.children().eq(0).width());
      let itemArr = [];
      for (let i = 0; i < colLength; i++) {
        itemArr[i] = 0;
      }

      this.$ct.children().each(function () {
        let minValue = Math.min.apply(null, itemArr);
        let minIndex = itemArr.indexOf(minValue);

        $(this).css({
          top: itemArr[minIndex],
          left: $(this).outerWidth(true) * minIndex
        });

        itemArr[minIndex] += $(this).outerHeight(true);
      });
    };

    return {
      init: function ($ct) {
        new waterFull($ct);
      }
    }
  })();
  WaterFull.init($('.content'));

  var loadMore = (function () {
    function _loadMore($ct) {
      this.$ct = $ct;
      this.$lm = $('.lm');
      this.init();
      this.bind();
    }

    _loadMore.prototype.init = function () {
      let curNum = 14;
      let that = this;
      this.$lm.click(function (event) {
        event.preventDefault();
        that.$lm.hide();
        $.ajax({
          url: '/loadMore',
          dataType: 'json',
          data: {curNum: curNum}
        })
          .done(function (data) {
            let res = data.randomHs;
            curNum = data.num;
            for (let i = 0; i < res.length; i++) {
              let data = res[i];
              let num = i + curNum;
              $(`<div class="item ${data}">${num}</div>`).appendTo(that.$ct)
            }
            WaterFull.init($('.content'));
          })
      });
    };

    _loadMore.prototype.bind = function () {
      let that = this;
      $(window).on('scroll',function () {
        let lastItem = $('.item').length;
        let bottom = $('.item').eq(lastItem - 1).offset().top ;
        let top = $('.item').eq(0).offset().top;
        let height = bottom - top + 310;
        that.$ct.css({
          "position": "relative",
          "height": height,
          "z-index": "-100"
        });
        that.$lm.show();
      })
    };

    return {
      init: function ($ct) {
        new _loadMore($ct)
      }
    };
  })();
  loadMore.init($('.content'));


</script>
</body>
</html>